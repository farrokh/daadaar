# Daadaar Platform Agent Rules

You are an expert AI developer working on the Daadaar Platform. You must follow these rules to maintain the integrity, privacy, and architecture of the project.

## 1. Privacy & Anonymity First
- **Always** support anonymous contributions via `sessionId`.
- Every "contributable" entity (Reports, Organizations, People, Roles) must have both `createdByUserId` (registered) and `sessionId` (anonymous).
- **Never** make `requireAuth` mandatory for creation endpoints unless specifically instructed. User `authMiddleware` instead to capture the session/user.

## 2. Database & Migrations
- **Schema Location**: Always edit `database/schema.ts`.
- **Migration Policy**: Following schema changes, follow the `database-migration` workflow.
- **NEVER** use `push` in a production environment; only use `generate` followed by `migrate`.

## 3. Backend Routes & Controllers
- **Middleware Order**: Use `authMiddleware` first to populate `req.currentUser`.
- **RequireAuth**: Use `requireAuth` only for sensitive actions (deleting, sensitive updates, admin/mod actions). Creation should ideally be anonymous-friendly.
- **Controller Types**: Use generic `Request` and `Response` from `express` for handlers that support both anonymous and registered users. Access user info via `req.currentUser`.

## 4. Internationalization (i18n)
- The platform supports Persian (fa) and English (en).
- **Frontend**: Use `useTranslations` from `next-intl`.
- **Backend/DB**: Most entities have dual fields (e.g., `name` for Persian, `nameEn` for English). Always ensure both are handled in controllers.

## 5. Security & Rate Limiting
- **PoW**: All high-stakes writes (Reports, Votes) MUST be protected by Proof-of-Work (PoW).
- **VPN Support**: Avoid IP-based rate limiting where possible; favor session-based and PoW-based limits to support users behind VPNs.

## 7. Frontend Development
- **Framework**: Use Next.js 16+ (App Router) with React 19+.
- **Styling**: Use Tailwind CSS 4. Follow the premium "Glassmorphic" design system (blurs, gradients, micro-animations).
- **Internationalization (i18n)**: Persian (fa) is primary. Support RTL for `fa` and LTR for `en`. Use `next-intl` for translations.
- **Graph Visualization**: Use React Flow for the `GraphCanvas`. Follow existing layout logic in `graph-layout.ts`.

## 8. Security Protocols
- **Proof-of-Work (PoW)**: Mandatory for all high-stakes write operations (Reports, Votes). Verify on backend using `pow-validator.ts`.
- **CSRF Protection**: All state-changing endpoints (POST, PUT, DELETE) must use the custom CSRF middleware.
- **XSS Prevention**: Always sanitize user-provided Markdown or rich text before rendering. Use the shared sanitization utility if available.
- **Zero IP Policy**: Never log or store user IP addresses. Rely on `sessionId` or `userId`.

## 9. Project Structure & Monorepo
- **frontend/**: Next.js app. Keep components small and modular.
- **backend/**: Express.js API. Use controller/route pattern.
- **database/**: Drizzle schema and migrations (always edit `database/schema.ts`).
- **shared/**: Types and logic shared between frontend/backend. Update `shared/types.ts` when changing database schemas.
- **docs/**: Keep architecture documentation updated with any structural changes.

## 10. Development Workflow
- **Database**: Use the `/database-migration` workflow for any schema changes.
- **Testing**: Run lint checks with `biome` before submitting code.
- **Commits**: Use descriptive commit messages following the project's conventional style.
