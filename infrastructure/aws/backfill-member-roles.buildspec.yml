version: 0.2

env:
  variables:
    DRY_RUN: "false"

phases:
  pre_build:
    commands:
      - echo "Logging in to ECR..."
      - aws ecr get-login-password --region "$AWS_REGION" | docker login --username AWS --password-stdin "$(echo "$IMAGE_URI" | cut -d/ -f1)"
  build:
    commands:
      - echo "Pulling image $IMAGE_URI"
      - docker pull "$IMAGE_URI"
      - |
        docker run --rm \
          -e DATABASE_URL="$DATABASE_URL" \
          -e DRY_RUN="$DRY_RUN" \
          "$IMAGE_URI" \
          bun /usr/src/app/backend/src/db/backfill-member-roles.ts
